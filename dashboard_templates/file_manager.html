<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Manager - OKR Pipeline</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-folder me-2"></i>File Manager
            </a>
            <a href="/" class="btn btn-outline-light">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </nav>
    
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-upload me-2"></i>Upload Files</h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label class="form-label">Target Directory:</label>
                                <select class="form-select" id="targetDirectory">
                                    <option value="uploads">Uploads</option>
                                    <option value="raw">Raw Data</option>
                                    <option value="processed">Processed</option>
                                    <option value="models">Models</option>
                                    <option value="results">Results</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Select Files:</label>
                                <input type="file" class="form-control" id="fileInput" multiple>
                                <div class="form-text">Maximum file size: 100MB per file</div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-upload"></i> Upload Files
                            </button>
                        </form>
                        
                        <div class="mt-3" id="uploadStatus" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar"></div>
                            </div>
                            <div class="mt-2 text-center">
                                <small id="uploadText">Uploading...</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie me-2"></i>Storage Statistics</h5>
                    </div>
                    <div class="card-body" id="storageStats">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-folder-open me-2"></i>File Browser</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshFileList()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="createNewFolder()">
                                <i class="fas fa-folder-plus"></i> New Folder
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Breadcrumb Navigation -->
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb" id="breadcrumb">
                                <li class="breadcrumb-item">
                                    <a href="#" onclick="navigateToPath('')">
                                        <i class="fas fa-home"></i> data
                                    </a>
                                </li>
                            </ol>
                        </nav>
                        
                        <!-- File List -->
                        <div class="border rounded" style="max-height: 500px; overflow-y: auto;">
                            <div id="fileList" class="list-group list-group-flush">
                                <div class="text-center p-4">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create Folder Modal -->
    <div class="modal fade" id="createFolderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Folder</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="folderName" class="form-label">Folder Name:</label>
                        <input type="text" class="form-control" id="folderName" placeholder="Enter folder name">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createFolder()">Create</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- File Info Modal -->
    <div class="modal fade" id="fileInfoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">File Information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="fileInfoContent">
                    <!-- File info will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="downloadFileBtn">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let currentPath = '';
        let currentFileInfo = {};
        
        document.addEventListener('DOMContentLoaded', function() {
            loadFileList();
            loadStorageStats();
            
            // Setup upload form
            document.getElementById('uploadForm').addEventListener('submit', handleFileUpload);
        });
        
        function loadFileList(path = '') {
            currentPath = path;
            
            fetch(`/api/files/list/${path}`)
                .then(response => response.json())
                .then(data => {
                    updateBreadcrumb(data.current_path);
                    updateFileList(data.files);
                })
                .catch(error => {
                    showAlert('Error loading files: ' + error.message, 'danger');
                });
        }
        
        function updateBreadcrumb(currentPath) {
            const breadcrumb = document.getElementById('breadcrumb');
            const pathParts = currentPath.split('/').filter(part => part);
            
            let breadcrumbHTML = `
                <li class="breadcrumb-item">
                    <a href="#" onclick="navigateToPath('')">
                        <i class="fas fa-home"></i> data
                    </a>
                </li>
            `;
            
            let buildPath = '';
            pathParts.forEach((part, index) => {
                buildPath += part;
                const isLast = index === pathParts.length - 1;
                
                if (isLast) {
                    breadcrumbHTML += `<li class="breadcrumb-item active">${part}</li>`;
                } else {
                    breadcrumbHTML += `
                        <li class="breadcrumb-item">
                            <a href="#" onclick="navigateToPath('${buildPath}')">${part}</a>
                        </li>
                    `;
                }
                buildPath += '/';
            });
            
            breadcrumb.innerHTML = breadcrumbHTML;
        }
        
        function updateFileList(files) {
            const fileList = document.getElementById('fileList');
            
            if (files.length === 0) {
                fileList.innerHTML = `
                    <div class="text-center p-4 text-muted">
                        <i class="fas fa-folder-open fa-3x mb-3"></i>
                        <p>This folder is empty</p>
                    </div>
                `;
                return;
            }
            
            const fileListHTML = files.map(file => {
                const isDirectory = file.type === 'directory';
                const icon = isDirectory ? 'fas fa-folder text-warning' : getFileIcon(file.name);
                const size = isDirectory ? '' : formatFileSize(file.size);
                const modifiedDate = new Date(file.modified).toLocaleDateString();
                
                return `
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center" onclick="${isDirectory ? `navigateToPath('${file.path}')` : `showFileInfo('${file.path}')`}" style="cursor: pointer; flex: 1;">
                            <i class="${icon} me-3" style="width: 20px;"></i>
                            <div>
                                <div class="fw-medium">${file.name}</div>
                                <small class="text-muted">${modifiedDate} ${size ? `• ${size}` : ''}</small>
                            </div>
                        </div>
                        <div class="btn-group" role="group">
                            ${!isDirectory ? `
                                <button class="btn btn-sm btn-outline-primary" onclick="downloadFile('${file.path}')" title="Download">
                                    <i class="fas fa-download"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-outline-info" onclick="showFileInfo('${file.path}')" title="Info">
                                <i class="fas fa-info-circle"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteFile('${file.path}', '${file.name}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            fileList.innerHTML = fileListHTML;
        }
        
        function getFileIcon(filename) {
            const extension = filename.split('.').pop().toLowerCase();
            const iconMap = {
                'csv': 'fas fa-file-csv text-success',
                'json': 'fas fa-file-code text-info',
                'txt': 'fas fa-file-alt text-secondary',
                'log': 'fas fa-file-alt text-warning',
                'py': 'fas fa-file-code text-primary',
                'js': 'fas fa-file-code text-warning',
                'html': 'fas fa-file-code text-danger',
                'css': 'fas fa-file-code text-primary',
                'pdf': 'fas fa-file-pdf text-danger',
                'doc': 'fas fa-file-word text-primary',
                'docx': 'fas fa-file-word text-primary',
                'xls': 'fas fa-file-excel text-success',
                'xlsx': 'fas fa-file-excel text-success',
                'jpg': 'fas fa-file-image text-info',
                'jpeg': 'fas fa-file-image text-info',
                'png': 'fas fa-file-image text-info',
                'gif': 'fas fa-file-image text-info',
                'zip': 'fas fa-file-archive text-warning',
                'tar': 'fas fa-file-archive text-warning',
                'gz': 'fas fa-file-archive text-warning',
                'pkl': 'fas fa-file text-danger',
                'joblib': 'fas fa-file text-danger',
                'model': 'fas fa-robot text-info'
            };
            return iconMap[extension] || 'fas fa-file text-muted';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function navigateToPath(path) {
            loadFileList(path);
        }
        
        function refreshFileList() {
            loadFileList(currentPath);
        }
        
        function showFileInfo(filePath) {
            // This would make an API call to get detailed file info
            // For now, show basic info
            currentFileInfo = { path: filePath };
            
            const content = document.getElementById('fileInfoContent');
            content.innerHTML = `
                <div class="mb-3">
                    <strong>File Path:</strong><br>
                    <code>${filePath}</code>
                </div>
                <div class="mb-3">
                    <strong>Actions:</strong><br>
                    <div class="btn-group w-100">
                        <button class="btn btn-outline-primary" onclick="downloadFile('${filePath}')">
                            <i class="fas fa-download"></i> Download
                        </button>
                        <button class="btn btn-outline-info" onclick="previewFile('${filePath}')">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('downloadFileBtn').onclick = () => downloadFile(filePath);
            
            const modal = new bootstrap.Modal(document.getElementById('fileInfoModal'));
            modal.show();
        }
        
        function downloadFile(filePath) {
            window.open(`/api/files/download/${filePath}`, '_blank');
        }
        
        function deleteFile(filePath, fileName) {
            if (confirm(`Are you sure you want to delete "${fileName}"?`)) {
                // This would make an API call to delete the file
                showAlert('File deletion not implemented yet', 'warning');
            }
        }
        
        function createNewFolder() {
            const modal = new bootstrap.Modal(document.getElementById('createFolderModal'));
            modal.show();
        }
        
        function createFolder() {
            const folderName = document.getElementById('folderName').value.trim();
            if (!folderName) {
                showAlert('Please enter a folder name', 'warning');
                return;
            }
            
            // This would make an API call to create the folder
            showAlert('Folder creation not implemented yet', 'warning');
            
            // Close modal and clear input
            bootstrap.Modal.getInstance(document.getElementById('createFolderModal')).hide();
            document.getElementById('folderName').value = '';
        }
        
        function handleFileUpload(event) {
            event.preventDefault();
            
            const fileInput = document.getElementById('fileInput');
            const directory = document.getElementById('targetDirectory').value;
            const files = fileInput.files;
            
            if (files.length === 0) {
                showAlert('Please select files to upload', 'warning');
                return;
            }
            
            const formData = new FormData();
            Array.from(files).forEach(file => {
                formData.append('file', file);
            });
            formData.append('directory', directory);
            
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadText = document.getElementById('uploadText');
            const progressBar = uploadStatus.querySelector('.progress-bar');
            
            uploadStatus.style.display = 'block';
            uploadText.textContent = 'Uploading files...';
            progressBar.style.width = '0%';
            
            // Simulate progress (in real implementation, use XMLHttpRequest for progress tracking)
            const progressInterval = setInterval(() => {
                const currentWidth = parseInt(progressBar.style.width) || 0;
                if (currentWidth < 90) {
                    progressBar.style.width = (currentWidth + 10) + '%';
                }
            }, 200);
            
            fetch('/api/files/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                
                if (data.message) {
                    uploadText.textContent = 'Upload successful!';
                    showAlert(data.message, 'success');
                    fileInput.value = '';
                    setTimeout(() => {
                        uploadStatus.style.display = 'none';
                        refreshFileList();
                        loadStorageStats();
                    }, 2000);
                } else {
                    uploadText.textContent = 'Upload failed!';
                    showAlert(data.error || 'Upload failed', 'danger');
                    setTimeout(() => uploadStatus.style.display = 'none', 3000);
                }
            })
            .catch(error => {
                clearInterval(progressInterval);
                uploadText.textContent = 'Upload error!';
                showAlert('Upload error: ' + error.message, 'danger');
                setTimeout(() => uploadStatus.style.display = 'none', 3000);
            });
        }
        
        function loadStorageStats() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    if (data.data_stats) {
                        updateStorageStats(data.data_stats);
                    }
                })
                .catch(error => {
                    console.error('Error loading storage stats:', error);
                });
        }
        
        function updateStorageStats(dataStats) {
            const container = document.getElementById('storageStats');
            
            const totalFiles = Object.values(dataStats).reduce((sum, dir) => sum + dir.file_count, 0);
            const totalSize = Object.values(dataStats).reduce((sum, dir) => sum + dir.total_size_mb, 0);
            
            const statsHTML = `
                <div class="row text-center mb-3">
                    <div class="col-6">
                        <h4 class="text-primary">${totalFiles}</h4>
                        <small class="text-muted">Total Files</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">${totalSize.toFixed(2)} MB</h4>
                        <small class="text-muted">Total Size</small>
                    </div>
                </div>
                <hr>
                ${Object.entries(dataStats).map(([dir, stats]) => `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <span class="fw-medium">${dir}</span><br>
                            <small class="text-muted">${stats.file_count} files</small>
                        </div>
                        <div class="text-end">
                            <div class="badge bg-primary">${stats.total_size_mb.toFixed(1)} MB</div>
                        </div>
                    </div>
                `).join('')}
            `;
            
            container.innerHTML = statsHTML;
        }
        
        function previewFile(filePath) {
            // This would show a preview of the file content
            showAlert('File preview not implemented yet', 'info');
        }
        
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>