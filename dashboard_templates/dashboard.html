<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKR ML Pipeline - Unified Dashboard</title>
    
    <!-- Bootstrap 5.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <style>
        :root {
            --sidebar-width: 280px;
            --navbar-height: 60px;
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        
        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary-color) 0%, #34495e 100%);
            color: white;
            z-index: 1000;
            transition: all 0.3s ease;
            overflow-y: auto;
        }
        
        .sidebar.collapsed {
            width: 70px;
        }
        
        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #34495e;
        }
        
        .sidebar.collapsed .sidebar-header h4,
        .sidebar.collapsed .nav-link span {
            display: none;
        }
        
        .nav-link {
            color: #bdc3c7 !important;
            padding: 12px 20px;
            border-radius: 0;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover,
        .nav-link.active {
            background-color: var(--secondary-color);
            color: white !important;
        }
        
        .nav-link i {
            width: 20px;
            margin-right: 10px;
        }
        
        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            padding-top: var(--navbar-height);
            transition: all 0.3s ease;
            min-height: 100vh;
        }
        
        .main-content.expanded {
            margin-left: 70px;
        }
        
        /* Top Navbar */
        .top-navbar {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            height: var(--navbar-height);
            background: white;
            border-bottom: 1px solid #dee2e6;
            z-index: 999;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .top-navbar.expanded {
            left: 70px;
        }
        
        /* Cards */
        .metric-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        .metric-card .card-body {
            padding: 25px;
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Status Indicators */
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-healthy { background-color: var(--success-color); }
        .status-unhealthy { background-color: var(--danger-color); }
        .status-unknown { background-color: var(--warning-color); }
        .status-offline { background-color: #95a5a6; }
        
        /* Service Cards */
        .service-card {
            background: white;
            border-radius: 10px;
            border-left: 4px solid var(--secondary-color);
            transition: all 0.3s ease;
        }
        
        .service-card:hover {
            border-left-color: var(--success-color);
            transform: translateY(-2px);
        }
        
        /* File Manager */
        .file-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s ease;
        }
        
        .file-item:hover {
            background-color: #f8f9fa;
        }
        
        .file-icon {
            width: 24px;
            margin-right: 10px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            
            .main-content {
                margin-left: 70px;
            }
            
            .top-navbar {
                left: 70px;
            }
        }
        
        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1001;
            transition: all 0.3s ease;
        }
        
        .connection-status.connected {
            background-color: var(--success-color);
            color: white;
        }
        
        .connection-status.disconnected {
            background-color: var(--danger-color);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status disconnected">
        <i class="fas fa-wifi"></i> Connecting...
    </div>
    
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h4><i class="fas fa-chart-line me-2"></i>OKR Pipeline</h4>
            <button class="btn btn-link text-white p-0" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link active" href="#dashboard" data-tab="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#services" data-tab="services">
                    <i class="fas fa-server"></i>
                    <span>Services</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#files" data-tab="files">
                    <i class="fas fa-folder"></i>
                    <span>File Manager</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#monitoring" data-tab="monitoring">
                    <i class="fas fa-chart-bar"></i>
                    <span>Monitoring</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#logs" data-tab="logs">
                    <i class="fas fa-list"></i>
                    <span>Pipeline Logs</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#settings" data-tab="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </li>
        </ul>
    </nav>
    
    <!-- Top Navbar -->
    <nav class="top-navbar" id="topNavbar">
        <div class="d-flex justify-content-between w-100 align-items-center">
            <div>
                <h5 class="mb-0" id="pageTitle">Dashboard Overview</h5>
                <small class="text-muted">Real-time pipeline monitoring</small>
            </div>
            <div class="d-flex align-items-center">
                <span class="me-3">
                    <i class="fas fa-clock"></i>
                    <span id="currentTime"></span>
                </span>
                <span class="badge bg-primary me-2">
                    <i class="fas fa-users"></i>
                    <span id="connectedClients">0</span> clients
                </span>
                <button class="btn btn-outline-primary btn-sm" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <div class="container-fluid p-4">
            
            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <!-- System Metrics Row -->
                <div class="row mb-4">
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="metric-card">
                            <div class="card-body text-center">
                                <div class="metric-value text-primary" id="cpuUsage">--</div>
                                <div class="metric-label">CPU Usage</div>
                                <div class="progress mt-2">
                                    <div class="progress-bar bg-primary" id="cpuProgress"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="metric-card">
                            <div class="card-body text-center">
                                <div class="metric-value text-success" id="memoryUsage">--</div>
                                <div class="metric-label">Memory Usage</div>
                                <div class="progress mt-2">
                                    <div class="progress-bar bg-success" id="memoryProgress"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="metric-card">
                            <div class="card-body text-center">
                                <div class="metric-value text-warning" id="diskUsage">--</div>
                                <div class="metric-label">Disk Usage</div>
                                <div class="progress mt-2">
                                    <div class="progress-bar bg-warning" id="diskProgress"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="metric-card">
                            <div class="card-body text-center">
                                <div class="metric-value text-info" id="activeServices">--</div>
                                <div class="metric-label">Active Services</div>
                                <div class="mt-2">
                                    <small class="text-muted">Load: <span id="loadAverage">--</span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Pipeline Overview -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5><i class="fas fa-project-diagram me-2"></i>Pipeline Status Overview</h5>
                            </div>
                            <div class="card-body">
                                <div class="row text-center" id="pipelineOverview">
                                    <!-- Pipeline steps will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 mb-2">
                                        <button class="btn btn-success w-100" onclick="startAllServices()">
                                            <i class="fas fa-play"></i> Start All Services
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <button class="btn btn-warning w-100" onclick="restartPipeline()">
                                            <i class="fas fa-redo"></i> Restart Pipeline
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <button class="btn btn-info w-100" onclick="showFileUpload()">
                                            <i class="fas fa-upload"></i> Upload Data
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <button class="btn btn-secondary w-100" onclick="downloadResults()">
                                            <i class="fas fa-download"></i> Download Results
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Services Tab -->
            <div id="services-tab" class="tab-content">
                <div class="row" id="servicesContainer">
                    <!-- Service cards will be populated here -->
                </div>
            </div>
            
            <!-- File Manager Tab -->
            <div id="files-tab" class="tab-content">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-upload me-2"></i>File Upload</h5>
                            </div>
                            <div class="card-body">
                                <form id="uploadForm" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label class="form-label">Select Directory:</label>
                                        <select class="form-select" id="uploadDirectory">
                                            <option value="uploads">Uploads</option>
                                            <option value="raw">Raw Data</option>
                                            <option value="processed">Processed</option>
                                            <option value="models">Models</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Choose File:</label>
                                        <input type="file" class="form-control" id="fileInput" multiple>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-upload"></i> Upload Files
                                    </button>
                                </form>
                                <div class="mt-3" id="uploadProgress" style="display: none;">
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-pie me-2"></i>Data Statistics</h5>
                            </div>
                            <div class="card-body" id="dataStats">
                                <!-- Data statistics will be populated here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-folder me-2"></i>File Browser</h5>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="refreshFiles()">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <nav aria-label="breadcrumb">
                                    <ol class="breadcrumb" id="fileBreadcrumb">
                                        <li class="breadcrumb-item"><a href="#" onclick="navigateToPath('')">data</a></li>
                                    </ol>
                                </nav>
                                <div id="fileList" class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                                    <!-- File list will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Monitoring Tab -->
            <div id="monitoring-tab" class="tab-content">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-line me-2"></i>System Performance</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="systemChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-network-wired me-2"></i>Network Activity</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="networkChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Logs Tab -->
            <div id="logs-tab" class="tab-content">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-list me-2"></i>Pipeline Logs</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshLogs()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="logContainer" style="max-height: 500px; overflow-y: auto; font-family: monospace; font-size: 0.9rem;">
                            <!-- Logs will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-cog me-2"></i>Dashboard Settings</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Update Interval (seconds):</label>
                                    <input type="number" class="form-control" id="updateInterval" value="15" min="5" max="60">
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                                        <label class="form-check-label" for="autoRefresh">Auto Refresh</label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="soundNotifications">
                                        <label class="form-check-label" for="soundNotifications">Sound Notifications</label>
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-info-circle me-2"></i>System Information</h5>
                            </div>
                            <div class="card-body">
                                <div id="systemInfo">
                                    <!-- System info will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </main>
    
    <!-- File Upload Modal -->
    <div class="modal fade" id="fileUploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Files</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="file" class="form-control" id="modalFileInput" multiple>
                    </div>
                    <div class="progress" style="display: none;" id="modalUploadProgress">
                        <div class="progress-bar" role="progressbar"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="uploadModalFiles()">Upload</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let socket;
        let systemChart, networkChart;
        let currentPath = '';
        let dashboardData = {};
        
        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            initializeInterface();
            initializeCharts();
            startClock();
            loadSettings();
        });
        
        // Socket.IO connection
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                updateConnectionStatus(true);
                console.log('Connected to server');
            });
            
            socket.on('disconnect', function() {
                updateConnectionStatus(false);
                console.log('Disconnected from server');
            });
            
            socket.on('dashboard_update', function(data) {
                updateDashboard(data);
            });
        }
        
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.className = 'connection-status connected';
                status.innerHTML = '<i class="fas fa-wifi"></i> Connected';
            } else {
                status.className = 'connection-status disconnected';
                status.innerHTML = '<i class="fas fa-wifi"></i> Disconnected';
            }
        }
        
        function initializeInterface() {
            // Sidebar toggle
            document.getElementById('sidebarToggle').addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.getElementById('mainContent');
                const topNavbar = document.getElementById('topNavbar');
                
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('expanded');
                topNavbar.classList.toggle('expanded');
            });
            
            // Tab navigation
            document.querySelectorAll('[data-tab]').forEach(function(tab) {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    switchTab(this.dataset.tab);
                });
            });
            
            // File upload form
            document.getElementById('uploadForm').addEventListener('submit', function(e) {
                e.preventDefault();
                uploadFiles();
            });
        }
        
        function switchTab(tabName) {
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Update page title
            const titles = {
                'dashboard': 'Dashboard Overview',
                'services': 'Service Management',
                'files': 'File Manager',
                'monitoring': 'System Monitoring',
                'logs': 'Pipeline Logs',
                'settings': 'Dashboard Settings'
            };
            document.getElementById('pageTitle').textContent = titles[tabName] || 'Dashboard';
            
            // Load tab-specific data
            if (tabName === 'files') {
                refreshFiles();
            } else if (tabName === 'logs') {
                refreshLogs();
            }
        }
        
        function updateDashboard(data) {
            dashboardData = data;
            
            // Update system metrics
            if (data.system) {
                updateSystemMetrics(data.system);
            }
            
            // Update services
            if (data.services) {
                updateServices(data.services);
            }
            
            // Update data stats
            if (data.data_stats) {
                updateDataStats(data.data_stats);
            }
            
            // Update charts
            updateCharts(data.system);
        }
        
        function updateSystemMetrics(system) {
            if (system.cpu_percent !== undefined) {
                document.getElementById('cpuUsage').textContent = system.cpu_percent + '%';
                document.getElementById('cpuProgress').style.width = system.cpu_percent + '%';
            }
            
            if (system.memory_percent !== undefined) {
                document.getElementById('memoryUsage').textContent = system.memory_percent + '%';
                document.getElementById('memoryProgress').style.width = system.memory_percent + '%';
            }
            
            if (system.disk_percent !== undefined) {
                document.getElementById('diskUsage').textContent = system.disk_percent + '%';
                document.getElementById('diskProgress').style.width = system.disk_percent + '%';
            }
            
            if (system.load_avg) {
                document.getElementById('loadAverage').textContent = system.load_avg.join(', ');
            }
        }
        
        function updateServices(services) {
            const container = document.getElementById('servicesContainer');
            container.innerHTML = '';
            
            let activeCount = 0;
            
            Object.entries(services).forEach(([name, service]) => {
                if (service.status === 'healthy') activeCount++;
                
                const statusClass = `status-${service.status}`;
                const cardHtml = `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card service-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="card-title mb-1">${name.toUpperCase()}</h6>
                                        <div class="d-flex align-items-center">
                                            <span class="status-indicator ${statusClass}"></span>
                                            <span class="text-capitalize">${service.status}</span>
                                        </div>
                                        <small class="text-muted">Port: ${service.port || 'N/A'}</small>
                                    </div>
                                    <div class="btn-group-vertical btn-group-sm">
                                        <button class="btn btn-outline-success btn-sm" onclick="controlService('${name}', 'start')">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm" onclick="controlService('${name}', 'restart')">
                                            <i class="fas fa-redo"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="controlService('${name}', 'stop')">
                                            <i class="fas fa-stop"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHtml;
            });
            
            document.getElementById('activeServices').textContent = activeCount;
            
            // Update pipeline overview
            updatePipelineOverview(services);
        }
        
        function updatePipelineOverview(services) {
            const container = document.getElementById('pipelineOverview');
            const steps = [
                {name: 'Data Source', service: 'postgres', icon: 'database'},
                {name: 'Stream Processing', service: 'kafka', icon: 'stream'},
                {name: 'Workflow Engine', service: 'airflow', icon: 'sitemap'},
                {name: 'ML Training', service: 'mlflow', icon: 'robot'},
                {name: 'API Service', service: 'api', icon: 'server'},
            ];
            
            container.innerHTML = steps.map(step => {
                const service = services[step.service] || {status: 'unknown'};
                const statusClass = `status-${service.status}`;
                
                return `
                    <div class="col-md-2 col-6 mb-3">
                        <div class="text-center">
                            <i class="fas fa-${step.icon} fa-3x text-muted mb-2"></i>
                            <h6>${step.name}</h6>
                            <span class="status-indicator ${statusClass}"></span>
                            <small class="text-capitalize">${service.status}</small>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateDataStats(dataStats) {
            const container = document.getElementById('dataStats');
            if (!container) return;
            
            const statsHtml = Object.entries(dataStats).map(([dir, stats]) => `
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold">${dir}</span>
                        <span class="badge bg-primary">${stats.file_count} files</span>
                    </div>
                    <small class="text-muted">${stats.total_size_mb} MB</small>
                </div>
            `).join('');
            
            container.innerHTML = statsHtml;
        }
        
        function initializeCharts() {
            // System performance chart
            const systemCtx = document.getElementById('systemChart');
            if (systemCtx) {
                systemChart = new Chart(systemCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'CPU %',
                            data: [],
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }, {
                            label: 'Memory %',
                            data: [],
                            borderColor: 'rgb(255, 99, 132)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true, max: 100 }
                        }
                    }
                });
            }
            
            // Network chart
            const networkCtx = document.getElementById('networkChart');
            if (networkCtx) {
                networkChart = new Chart(networkCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Sent (MB)',
                            data: [],
                            borderColor: 'rgb(54, 162, 235)',
                            tension: 0.1
                        }, {
                            label: 'Received (MB)',
                            data: [],
                            borderColor: 'rgb(255, 206, 86)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
        }
        
        function updateCharts(systemData) {
            if (!systemData || !systemChart) return;
            
            const now = new Date().toLocaleTimeString();
            
            // Update system chart
            systemChart.data.labels.push(now);
            systemChart.data.datasets[0].data.push(systemData.cpu_percent || 0);
            systemChart.data.datasets[1].data.push(systemData.memory_percent || 0);
            
            // Keep only last 20 data points
            if (systemChart.data.labels.length > 20) {
                systemChart.data.labels.shift();
                systemChart.data.datasets.forEach(dataset => dataset.data.shift());
            }
            
            systemChart.update('none');
            
            // Update network chart
            if (networkChart && systemData.network_sent_mb !== undefined) {
                networkChart.data.labels.push(now);
                networkChart.data.datasets[0].data.push(systemData.network_sent_mb);
                networkChart.data.datasets[1].data.push(systemData.network_recv_mb);
                
                if (networkChart.data.labels.length > 20) {
                    networkChart.data.labels.shift();
                    networkChart.data.datasets.forEach(dataset => dataset.data.shift());
                }
                
                networkChart.update('none');
            }
        }
        
        function startClock() {
            function updateTime() {
                const now = new Date();
                document.getElementById('currentTime').textContent = now.toLocaleTimeString();
            }
            updateTime();
            setInterval(updateTime, 1000);
        }
        
        // Service control functions
        function controlService(serviceName, action) {
            fetch(`/api/services/${serviceName}/${action}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast(`Service ${serviceName} ${action}ed successfully`, 'success');
                } else {
                    showToast(`Failed to ${action} ${serviceName}: ${data.message}`, 'error');
                }
                // Refresh data after a short delay
                setTimeout(refreshData, 2000);
            })
            .catch(error => {
                showToast(`Error controlling service: ${error.message}`, 'error');
            });
        }
        
        function startAllServices() {
            const services = ['postgres', 'kafka', 'airflow', 'api', 'mlflow'];
            services.forEach(service => {
                setTimeout(() => controlService(service, 'start'), Math.random() * 2000);
            });
        }
        
        function restartPipeline() {
            if (confirm('Are you sure you want to restart the entire pipeline?')) {
                const services = ['kafka', 'airflow', 'api'];
                services.forEach((service, index) => {
                    setTimeout(() => controlService(service, 'restart'), index * 3000);
                });
            }
        }
        
        // File management functions
        function refreshFiles() {
            fetch(`/api/files/list/${currentPath}`)
            .then(response => response.json())
            .then(data => {
                updateFileList(data);
            })
            .catch(error => {
                showToast('Error loading files: ' + error.message, 'error');
            });
        }
        
        function updateFileList(data) {
            const container = document.getElementById('fileList');
            const breadcrumb = document.getElementById('fileBreadcrumb');
            
            // Update breadcrumb
            const pathParts = data.current_path.split('/').filter(part => part);
            breadcrumb.innerHTML = '<li class="breadcrumb-item"><a href="#" onclick="navigateToPath(\'\')">data</a></li>';
            
            let currentPathBuild = '';
            pathParts.forEach(part => {
                currentPathBuild += part + '/';
                breadcrumb.innerHTML += `<li class="breadcrumb-item"><a href="#" onclick="navigateToPath('${currentPathBuild.slice(0, -1)}')">${part}</a></li>`;
            });
            
            // Update file list
            container.innerHTML = data.files.map(file => {
                const icon = file.type === 'directory' ? 'fas fa-folder text-warning' : 'fas fa-file text-muted';
                const size = file.type === 'file' ? `(${formatFileSize(file.size)})` : '';
                const onclick = file.type === 'directory' ? 
                    `onclick="navigateToPath('${file.path}')"` : 
                    `onclick="downloadFile('${file.path}')"`;
                
                return `
                    <div class="file-item d-flex justify-content-between align-items-center" ${onclick} style="cursor: pointer;">
                        <div>
                            <i class="${icon} file-icon"></i>
                            <span>${file.name}</span>
                            <small class="text-muted ms-2">${size}</small>
                        </div>
                        <small class="text-muted">${new Date(file.modified).toLocaleDateString()}</small>
                    </div>
                `;
            }).join('');
        }
        
        function navigateToPath(path) {
            currentPath = path;
            refreshFiles();
        }
        
        function downloadFile(filePath) {
            window.open(`/api/files/download/${filePath}`, '_blank');
        }
        
        function uploadFiles() {
            const fileInput = document.getElementById('fileInput');
            const directory = document.getElementById('uploadDirectory').value;
            const files = fileInput.files;
            
            if (files.length === 0) {
                showToast('Please select files to upload', 'warning');
                return;
            }
            
            const formData = new FormData();
            for (let file of files) {
                formData.append('file', file);
            }
            formData.append('directory', directory);
            
            const progress = document.getElementById('uploadProgress');
            progress.style.display = 'block';
            
            fetch('/api/files/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    showToast(data.message, 'success');
                    fileInput.value = '';
                    refreshFiles();
                } else {
                    showToast(data.error || 'Upload failed', 'error');
                }
            })
            .catch(error => {
                showToast('Upload error: ' + error.message, 'error');
            })
            .finally(() => {
                progress.style.display = 'none';
            });
        }
        
        function showFileUpload() {
            const modal = new bootstrap.Modal(document.getElementById('fileUploadModal'));
            modal.show();
        }
        
        function downloadResults() {
            // Trigger download of latest results
            window.open('/api/files/download/results', '_blank');
        }
        
        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function refreshData() {
            socket.emit('request_update');
        }
        
        function refreshLogs() {
            fetch('/api/pipeline/logs')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('logContainer');
                container.innerHTML = data.logs.map(log => {
                    const statusClass = log.status === 'success' ? 'text-success' : 'text-danger';
                    return `
                        <div class="mb-2">
                            <span class="text-muted">[${new Date(log.timestamp).toLocaleTimeString()}]</span>
                            <span class="${statusClass}">${log.action}</span>
                            - ${log.message}
                        </div>
                    `;
                }).join('');
                container.scrollTop = container.scrollHeight;
            });
        }
        
        function showToast(message, type = 'info') {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 5000);
        }
        
        function saveSettings() {
            const settings = {
                updateInterval: document.getElementById('updateInterval').value,
                autoRefresh: document.getElementById('autoRefresh').checked,
                soundNotifications: document.getElementById('soundNotifications').checked
            };
            
            localStorage.setItem('dashboardSettings', JSON.stringify(settings));
            showToast('Settings saved successfully', 'success');
        }
        
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('dashboardSettings') || '{}');
            
            if (settings.updateInterval) {
                document.getElementById('updateInterval').value = settings.updateInterval;
            }
            if (settings.autoRefresh !== undefined) {
                document.getElementById('autoRefresh').checked = settings.autoRefresh;
            }
            if (settings.soundNotifications !== undefined) {
                document.getElementById('soundNotifications').checked = settings.soundNotifications;
            }
        }
    </script>
</body>
</html>