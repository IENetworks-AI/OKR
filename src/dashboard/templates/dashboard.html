<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKR ML Pipeline Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .status-healthy { background-color: #27ae60; }
        .status-unhealthy { background-color: #e74c3c; }
        .status-unknown { background-color: #f39c12; }
        .status-error { background-color: #e74c3c; }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card-header { background: linear-gradient(135deg, #2c3e50, #3498db); color: white; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-brain me-2"></i>OKR ML Pipeline Dashboard
            </span>
            <span class="navbar-text">
                <i class="fas fa-circle text-success me-2"></i>Real-time Monitoring
            </span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- System Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-server me-2"></i>System Overview
                    </div>
                    <div class="card-body">
                        <div class="row" id="system-metrics">
                            <div class="col-md-3 text-center">
                                <h3 id="cpu-percent">--</h3>
                                <p>CPU Usage</p>
                            </div>
                            <div class="col-md-3 text-center">
                                <h3 id="memory-percent">--</h3>
                                <p>Memory Usage</p>
                            </div>
                            <div class="col-md-3 text-center">
                                <h3 id="disk-percent">--</h3>
                                <p>Disk Usage</p>
                            </div>
                            <div class="col-md-3 text-center">
                                <h3 id="active-services">--</h3>
                                <p>Active Services</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Service Status -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card" id="kafka-card">
                    <div class="card-header">
                        <i class="fas fa-stream me-2"></i>Kafka Status
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>
                                <span class="status-indicator" id="kafka-status-indicator"></span>
                                <span id="kafka-status-text">Checking...</span>
                            </span>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="restartService('kafka')">Restart</button>
                                <button class="btn btn-sm btn-outline-success" onclick="startService('kafka')">Start</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="stopService('kafka')">Stop</button>
                            </div>
                        </div>
                        <div id="kafka-details">Loading...</div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card" id="airflow-card">
                    <div class="card-header">
                        <i class="fas fa-project-diagram me-2"></i>Airflow Status
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>
                                <span class="status-indicator" id="airflow-status-indicator"></span>
                                <span id="airflow-status-text">Checking...</span>
                            </span>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="restartService('airflow')">Restart</button>
                                <button class="btn btn-sm btn-outline-success" onclick="startService('airflow')">Start</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="stopService('airflow')">Stop</button>
                            </div>
                        </div>
                        <div id="airflow-details">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ML Pipeline -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card" id="ml-card">
                    <div class="card-header">
                        <i class="fas fa-robot me-2"></i>ML Pipeline Status
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>
                                <span class="status-indicator" id="ml-status-indicator"></span>
                                <span id="ml-status-text">Checking...</span>
                            </span>
                            <button class="btn btn-sm btn-success" onclick="runMLTraining()">Run Training</button>
                        </div>
                        <div id="ml-details">Loading...</div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-database me-2"></i>Data Pipeline Status
                    </div>
                    <div class="card-body">
                        <div id="data-details">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Docker Services -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-docker me-2"></i>Docker Services
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="docker-table">
                                <thead>
                                    <tr>
                                        <th>Service</th>
                                        <th>Status</th>
                                        <th>Image</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="4" class="text-center">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button class="btn btn-primary position-fixed bottom-0 end-0 m-3" onclick="refreshAll()">
        <i class="fas fa-sync-alt"></i> Refresh
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <script>
        let socket;
        
        document.addEventListener('DOMContentLoaded', function() {
            connectWebSocket();
            refreshAll();
            setInterval(refreshAll, 30000);
        });

        function connectWebSocket() {
            socket = io();
            socket.on('status_update', function(data) {
                updatePipelineStatus(data);
            });
        }

        async function refreshAll() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                updateDashboard(data);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function updateDashboard(data) {
            updateSystemMetrics(data.system);
            updatePipelineStatus(data.pipeline);
            updateDockerServices(data.docker);
            updateDataStatus(data.data);
        }

        function updateSystemMetrics(system) {
            if (system.error) return;
            document.getElementById('cpu-percent').textContent = system.cpu_percent + '%';
            document.getElementById('memory-percent').textContent = system.memory_percent + '%';
            document.getElementById('disk-percent').textContent = system.disk_percent + '%';
        }

        function updatePipelineStatus(pipeline) {
            updateServiceStatus('kafka', pipeline.kafka);
            updateServiceStatus('airflow', pipeline.airflow);
            updateServiceStatus('ml', pipeline.ml_pipeline);
        }

        function updateServiceStatus(service, status) {
            const indicator = document.getElementById(`${service}-status-indicator`);
            const text = document.getElementById(`${service}-status-text`);
            const details = document.getElementById(`${service}-details`);
            
            if (indicator && text) {
                indicator.className = `status-indicator status-${status.status}`;
                text.textContent = status.status.charAt(0).toUpperCase() + status.status.slice(1);
            }
            
            if (details) {
                let html = '';
                if (service === 'kafka') {
                    html = `<p><strong>Topics:</strong> ${status.topics ? status.topics.length : 0}</p>`;
                } else if (service === 'airflow') {
                    html = `<p><strong>DAGs:</strong> ${status.dags ? status.dags.length : 0}</p>`;
                } else if (service === 'ml') {
                    html = `<p><strong>Models:</strong> ${status.model_count || 0}</p>`;
                }
                if (status.error) html += `<p class="text-danger">Error: ${status.error}</p>`;
                details.innerHTML = html;
            }
        }

        function updateDockerServices(containers) {
            const tbody = document.querySelector('#docker-table tbody');
            if (containers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">No services found</td></tr>';
                return;
            }
            
            let html = '';
            containers.forEach(container => {
                const statusClass = container.status === 'running' ? 'success' : 'danger';
                html += `
                    <tr>
                        <td><strong>${container.name}</strong></td>
                        <td><span class="badge bg-${statusClass}">${container.status}</span></td>
                        <td><code>${container.image}</code></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="restartService('${container.name}')">Restart</button>
                            <button class="btn btn-sm btn-outline-success" onclick="startService('${container.name}')">Start</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="stopService('${container.name}')">Stop</button>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
            
            const activeServices = containers.filter(c => c.status === 'running').length;
            document.getElementById('active-services').textContent = activeServices;
        }

        function updateDataStatus(data) {
            const details = document.getElementById('data-details');
            if (data.error) {
                details.innerHTML = `<p class="text-danger">Error: ${data.error}</p>`;
                return;
            }
            
            let html = '<div class="row">';
            Object.entries(data).forEach(([dir, info]) => {
                html += `
                    <div class="col-md-4 mb-3">
                        <div class="card border-0 bg-light">
                            <div class="card-body p-3">
                                <h6 class="text-capitalize">${dir}</h6>
                                <p class="mb-1"><strong>Files:</strong> ${info.file_count}</p>
                                <p class="mb-0"><strong>Size:</strong> ${info.size_mb.toFixed(2)} MB</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            details.innerHTML = html;
        }

        async function restartService(serviceName) {
            try {
                const response = await fetch('/api/actions/restart_service', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({service: serviceName})
                });
                if (response.ok) {
                    setTimeout(refreshAll, 2000);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function startService(serviceName) {
            try {
                const response = await fetch('/api/actions/start_service', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({service: serviceName})
                });
                if (response.ok) {
                    setTimeout(refreshAll, 2000);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function stopService(serviceName) {
            try {
                const response = await fetch('/api/actions/stop_service', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({service: serviceName})
                });
                if (response.ok) {
                    setTimeout(refreshAll, 2000);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function runMLTraining() {
            try {
                const response = await fetch('/api/actions/run_ml_training', {method: 'POST'});
                if (response.ok) {
                    alert('ML training initiated successfully!');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>
