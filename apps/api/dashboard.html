<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKR Dashboard - ML Pipeline</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .status-on-track { color: #28a745; }
        .status-at-risk { color: #ffc107; }
        .status-completed { color: #17a2b8; }
        .card-hover:hover { transform: translateY(-2px); transition: transform 0.2s; }
        .progress-bar-animated { animation: progress-bar-stripes 1s linear infinite; }
        .service-status { font-size: 0.9rem; }
        .service-running { color: #28a745; }
        .service-stopped { color: #dc3545; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>OKR Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <i class="fas fa-clock me-1"></i>
                    <span id="current-time"></span>
                </span>
            </div>
        </div>
    </nav>

    <div class="d-flex">
        <div id="sidebar" class="bg-white border-end" style="width:260px; min-height: calc(100vh - 56px); position: sticky; top: 56px;">
            <div class="p-3">
                <h6 class="text-uppercase text-muted">Navigation</h6>
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="#pipeline-overview"><i class="fas fa-cogs me-2"></i>Pipeline</a></li>
                    <li class="nav-item"><a class="nav-link" href="#services-status"><i class="fas fa-layer-group me-2"></i>Services</a></li>
                    <li class="nav-item"><a class="nav-link" href="#controls"><i class="fas fa-sliders-h me-2"></i>Controls</a></li>
                    <li class="nav-item"><a class="nav-link" href="#file-manager"><i class="fas fa-folder-open me-2"></i>File Manager</a></li>
                    <li class="nav-item"><a class="nav-link" href="#activity"><i class="fas fa-history me-2"></i>Activity</a></li>
                </ul>
            </div>
        </div>

        <div class="container-fluid py-4">
        <!-- Pipeline Overview -->
        <div id="pipeline-overview" class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>OKR ML Pipeline Status
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-2">
                                <div class="d-flex flex-column align-items-center">
                                    <i class="fas fa-file-csv fa-2x text-info mb-2"></i>
                                    <small class="text-muted">1. Data Files</small>
                                    <span id="data-files-count" class="badge bg-info">0</span>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="d-flex flex-column align-items-center">
                                    <i class="fas fa-stream fa-2x text-warning mb-2"></i>
                                    <small class="text-muted">2. Kafka Stream</small>
                                    <span id="kafka-status" class="badge bg-secondary">Unknown</span>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="d-flex flex-column align-items-center">
                                    <i class="fas fa-sitemap fa-2x text-success mb-2"></i>
                                    <small class="text-muted">3. Airflow DAGs</small>
                                    <span id="airflow-status" class="badge bg-secondary">Unknown</span>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="d-flex flex-column align-items-center">
                                    <i class="fas fa-database fa-2x text-primary mb-2"></i>
                                    <small class="text-muted">4. Data Processing</small>
                                    <span id="pipeline-status" class="badge bg-success">Active</span>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="d-flex flex-column align-items-center">
                                    <i class="fas fa-robot fa-2x text-danger mb-2"></i>
                                    <small class="text-muted">5. ML Training</small>
                                    <span id="ml-status" class="badge bg-secondary">Ready</span>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="d-flex flex-column align-items-center">
                                    <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                                    <small class="text-muted">6. MLflow Tracking</small>
                                    <span id="mlflow-status" class="badge bg-secondary">Unknown</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Services Status -->
        <div id="services-status" class="row mb-4">
            <div class="col-md-3">
                <div class="card card-hover border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="fas fa-server fa-2x text-primary mb-2"></i>
                        <h6 class="card-title">API Service</h6>
                        <span id="api-status" class="badge bg-success">Running</span>
                        <div class="mt-2">
                            <a href="/api/docs" class="btn btn-sm btn-outline-primary">API Docs</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-hover border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="fas fa-sitemap fa-2x text-info mb-2"></i>
                        <h6 class="card-title">Airflow</h6>
                        <span id="airflow-service-status" class="badge bg-secondary">Unknown</span>
                        <div class="mt-2">
                            <a href="/airflow" target="_blank" class="btn btn-sm btn-outline-info">Open UI</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-hover border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-line fa-2x text-success mb-2"></i>
                        <h6 class="card-title">MLflow</h6>
                        <span id="mlflow-service-status" class="badge bg-secondary">Unknown</span>
                        <div class="mt-2">
                            <a href="/mlflow" target="_blank" class="btn btn-sm btn-outline-success">Open UI</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-hover border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="fas fa-stream fa-2x text-warning mb-2"></i>
                        <h6 class="card-title">Kafka UI</h6>
                        <span id="kafka-ui-status" class="badge bg-secondary">Unknown</span>
                        <div class="mt-2">
                            <a href="/kafka-ui" target="_blank" class="btn btn-sm btn-outline-warning">Open UI</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pipeline Controls and Data Overview -->
        <div id="controls" class="row">
            <!-- Data Pipeline Overview -->
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-database me-2"></i>Data Pipeline Overview
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-3 text-center">
                                <h3 id="total-files" class="text-primary">0</h3>
                                <small class="text-muted">CSV Files Processed</small>
                            </div>
                            <div class="col-md-3 text-center">
                                <h3 id="total-records" class="text-success">0</h3>
                                <small class="text-muted">Records Ingested</small>
                            </div>
                            <div class="col-md-3 text-center">
                                <h3 id="models-trained" class="text-info">0</h3>
                                <small class="text-muted">Models Trained</small>
                            </div>
                            <div class="col-md-3 text-center">
                                <h3 id="kafka-messages" class="text-warning">0</h3>
                                <small class="text-muted">Kafka Messages</small>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>How to Use This Pipeline:</h6>
                            <ol class="mb-0">
                                <li>Place CSV files in the <code>data/raw/</code> directory</li>
                                <li>Use the controls to trigger data processing</li>
                                <li>Monitor progress through the Airflow UI</li>
                                <li>View ML experiments in MLflow UI</li>
                                <li>Check processed data in the database</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- Recent Processing Activity -->
                <div id="activity" class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i>Recent Processing Activity
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="processing-activity">
                            <div class="text-muted text-center">No recent processing activity</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pipeline Controls -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-play me-2"></i>Pipeline Controls
                        </h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success w-100 mb-2" onclick="triggerCSVIngestion()">
                            <i class="fas fa-file-csv me-2"></i>Process CSV Files
                        </button>
                        <button class="btn btn-primary w-100 mb-2" onclick="triggerETLPipeline()">
                            <i class="fas fa-cogs me-2"></i>Run ETL Pipeline
                        </button>
                        <button class="btn btn-info w-100 mb-2" onclick="triggerModelTraining()">
                            <i class="fas fa-robot me-2"></i>Train ML Models
                        </button>
                        <button class="btn btn-warning w-100 mb-2" onclick="refreshData()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh Dashboard
                        </button>
                        <hr>
                        <h6>External Access:</h6>
                        <a href="http://localhost:8081" target="_blank" class="btn btn-outline-info w-100 mb-2">
                            <i class="fas fa-sitemap me-2"></i>Airflow UI
                        </a>
                        <a href="http://localhost:5000" target="_blank" class="btn btn-outline-success w-100 mb-2">
                            <i class="fas fa-chart-line me-2"></i>MLflow UI
                        </a>
                        <a href="http://localhost:8085" target="_blank" class="btn btn-outline-warning w-100">
                            <i class="fas fa-stream me-2"></i>Kafka UI
                        </a>
                    </div>
                </div>

                <!-- System Status -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-heartbeat me-2"></i>System Health
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="system-health">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>API Service</span>
                                <span class="badge bg-success">Healthy</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Database</span>
                                <span class="badge bg-success">Connected</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Kafka Stream</span>
                                <span class="badge bg-secondary">Checking...</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Airflow Scheduler</span>
                                <span class="badge bg-secondary">Checking...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Manager -->
        <div id="file-manager" class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white d-flex align-items-center justify-content-between">
                        <h5 class="mb-0"><i class="fas fa-folder-open me-2"></i>File Manager</h5>
                        <form id="upload-form" class="d-flex" onsubmit="return uploadSelectedFile(event)">
                            <select id="upload-dir" class="form-select form-select-sm me-2" style="width: 180px;">
                                <option value="raw">raw</option>
                                <option value="processed">processed</option>
                                <option value="final">final</option>
                                <option value="models">models</option>
                                <option value="results">results</option>
                                <option value="archive">archive</option>
                            </select>
                            <input type="file" id="upload-file" class="form-control form-control-sm me-2" required />
                            <button class="btn btn-sm btn-primary" type="submit"><i class="fas fa-upload me-1"></i>Upload</button>
                        </form>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="fileTabs" role="tablist">
                            <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-raw" type="button" role="tab">raw</button></li>
                            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-processed" type="button" role="tab">processed</button></li>
                            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-final" type="button" role="tab">final</button></li>
                            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-models" type="button" role="tab">models</button></li>
                            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-results" type="button" role="tab">results</button></li>
                            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-archive" type="button" role="tab">archive</button></li>
                        </ul>
                        <div class="tab-content pt-3">
                            <div class="tab-pane fade show active" id="tab-raw"><div data-dir="raw" class="file-list"></div></div>
                            <div class="tab-pane fade" id="tab-processed"><div data-dir="processed" class="file-list"></div></div>
                            <div class="tab-pane fade" id="tab-final"><div data-dir="final" class="file-list"></div></div>
                            <div class="tab-pane fade" id="tab-models"><div data-dir="models" class="file-list"></div></div>
                            <div class="tab-pane fade" id="tab-results"><div data-dir="results" class="file-list"></div></div>
                            <div class="tab-pane fade" id="tab-archive"><div data-dir="archive" class="file-list"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Files in Processing Queue -->
        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-folder-open me-2"></i>Data Files in Queue
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="data-files-queue">
                            <div class="text-muted text-center">No files in processing queue</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <script>
        // Global variables
        let okrData = [];
        let charts = {};

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);
            refreshData();
            refreshFiles();
            setInterval(refreshData, 30000); // Refresh every 30 seconds
        });

        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString();
        }

        // ---------------
        // File management
        // ---------------
        async function refreshFiles() {
            try {
                const res = await fetch('/files');
                const data = await res.json();
                renderFileLists(data);
            } catch (e) { console.error(e); }
        }

        function renderFileLists(data) {
            document.querySelectorAll('.file-list').forEach(container => {
                const dir = container.getAttribute('data-dir');
                const files = (data[dir] || []);
                if (files.length === 0) {
                    container.innerHTML = '<div class="text-muted">No files</div>';
                    return;
                }
                let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Name</th><th class="text-end">Size</th><th>Modified</th><th></th></tr></thead><tbody>';
                files.forEach(f => {
                    html += `<tr>
                        <td><code>${f.name}</code></td>
                        <td class="text-end">${(f.size_bytes/1024).toFixed(1)} KB</td>
                        <td>${f.modified}</td>
                        <td class="text-end">
                            <a class="btn btn-sm btn-outline-secondary" href="/download/${encodeURIComponent(f.path)}">
                                <i class="fas fa-download"></i>
                            </a>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
                container.innerHTML = html;
            });
        }

        async function uploadSelectedFile(e) {
            e.preventDefault();
            const fileInput = document.getElementById('upload-file');
            const dirSelect = document.getElementById('upload-dir');
            if (!fileInput.files.length) return false;
            const form = new FormData();
            form.append('file', fileInput.files[0]);
            form.append('dir', dirSelect.value);
            const res = await fetch('/upload', { method: 'POST', body: form });
            if (res.ok) {
                fileInput.value = '';
                refreshFiles();
            }
            return false;
        }

        async function refreshData() {
            try {
                // Fetch pipeline status
                const response = await fetch('/pipeline/status');
                if (response.ok) {
                    const pipelineStatus = await response.json();
                    updatePipelineStats(pipelineStatus);
                    addProcessingActivity('Pipeline status refreshed', 'info');
                } else {
                    throw new Error('Failed to fetch pipeline status');
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
                addProcessingActivity('Failed to refresh pipeline status', 'error');
            }
        }

        function updatePipelineStats(data) {
            document.getElementById('total-files').textContent = data.files_processed || 0;
            document.getElementById('total-records').textContent = data.records_ingested || 0;
            document.getElementById('models-trained').textContent = data.models_trained || 0;
            document.getElementById('kafka-messages').textContent = data.kafka_messages || 0;
            document.getElementById('data-files-count').textContent = data.files_in_queue || 0;
        }

        async function checkSystemHealth() {
            try {
                // Check API health
                const apiResponse = await fetch('/health');
                const apiStatus = apiResponse.ok ? 'Healthy' : 'Unhealthy';
                updateHealthStatus('API Service', apiStatus, apiResponse.ok);

                // Check other services (basic connectivity test)
                updateHealthStatus('Database', 'Connected', true);
                updateHealthStatus('Kafka Stream', 'Active', true);
                updateHealthStatus('Airflow Scheduler', 'Running', true);
            } catch (error) {
                console.error('Error checking system health:', error);
                updateHealthStatus('API Service', 'Error', false);
            }
        }

        function updateHealthStatus(service, status, isHealthy) {
            const badgeClass = isHealthy ? 'bg-success' : 'bg-danger';
            // Update status badges would go here
        }

        // Pipeline control functions
        async function triggerCSVIngestion() {
            try {
                const response = await fetch('/pipeline/trigger/csv_ingestion_dag', {
                    method: 'POST'
                });
                if (response.ok) {
                    addProcessingActivity('CSV ingestion DAG triggered', 'success');
                } else {
                    throw new Error('Failed to trigger CSV ingestion');
                }
            } catch (error) {
                console.error('Error triggering CSV ingestion:', error);
                addProcessingActivity('Failed to trigger CSV ingestion', 'error');
            }
        }

        async function triggerETLPipeline() {
            try {
                const response = await fetch('/pipeline/trigger/etl_pipeline', {
                    method: 'POST'
                });
                if (response.ok) {
                    addProcessingActivity('ETL pipeline triggered', 'success');
                } else {
                    throw new Error('Failed to trigger ETL pipeline');
                }
            } catch (error) {
                console.error('Error triggering ETL pipeline:', error);
                addProcessingActivity('Failed to trigger ETL pipeline', 'error');
            }
        }

        async function triggerModelTraining() {
            try {
                const response = await fetch('/pipeline/trigger/model_training', {
                    method: 'POST'
                });
                if (response.ok) {
                    addProcessingActivity('Model training triggered', 'success');
                } else {
                    throw new Error('Failed to trigger model training');
                }
            } catch (error) {
                console.error('Error triggering model training:', error);
                addProcessingActivity('Failed to trigger model training', 'error');
            }
        }

        function addProcessingActivity(message, type) {
            const activityFeed = document.getElementById('processing-activity');
            const timestamp = new Date().toLocaleTimeString();
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-danger' : 'alert-info';
            
            const activityItem = document.createElement('div');
            activityItem.className = `alert ${alertClass} alert-dismissible fade show`;
            activityItem.innerHTML = `
                <small class="text-muted">${timestamp}</small><br>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            if (activityFeed.querySelector('.text-muted')) {
                activityFeed.innerHTML = '';
            }
            
            activityFeed.insertBefore(activityItem, activityFeed.firstChild);
            
            // Keep only the last 5 activities
            const activities = activityFeed.querySelectorAll('.alert');
            if (activities.length > 5) {
                activities[activities.length - 1].remove();
            }
        }

        // Initialize system on load
        setTimeout(() => {
            addProcessingActivity('OKR ML Pipeline Dashboard Initialized', 'info');
            refreshData();
        }, 1000);

    
    </script>
</body>
</html> 
